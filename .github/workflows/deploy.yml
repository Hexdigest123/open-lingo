name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_seed:
        description: '⚠️ DANGER: Force re-seed database (DELETES ALL DATA!)'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: self-hosted

    env:
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      JWT_ACCESS_SECRET: ${{ secrets.JWT_ACCESS_SECRET }}
      JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
      ORIGIN: ${{ vars.ORIGIN }}
      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASS }}
      SMTP_FROM: ${{ secrets.SMTP_FROM }}
      PUBLIC_APP_URL: ${{ vars.PUBLIC_APP_URL }}
      LEGAL_COMPANY_NAME: ${{ vars.LEGAL_COMPANY_NAME }}
      LEGAL_ADDRESS: ${{ vars.LEGAL_ADDRESS }}
      LEGAL_EMAIL: ${{ vars.LEGAL_EMAIL }}
      LEGAL_PHONE: ${{ vars.LEGAL_PHONE }}
      LEGAL_REPRESENTATIVE: ${{ vars.LEGAL_REPRESENTATIVE }}
      LEGAL_VAT_ID: ${{ vars.LEGAL_VAT_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: false

      - name: Clean build artifacts
        run: sudo rm -rf .svelte-kit node_modules/.vite 2>/dev/null || true

      - name: Stop existing app container
        run: docker compose -f compose.yaml stop app || true

      - name: Build and start database
        run: docker compose -f compose.yaml up -d db

      - name: Wait for database to be healthy
        run: |
          echo "Waiting for database to be healthy..."
          timeout 60 bash -c 'until docker compose -f compose.yaml exec -T db pg_isready -U "$POSTGRES_USER" -d "$POSTGRES_DB"; do sleep 2; done'
          echo "Database is ready"

      - name: Install dependencies
        run: docker compose -f compose.yaml run --rm migrate npm ci

      - name: Initialize migration tracking
        run: |
          docker compose -f compose.yaml exec -T db psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c "
            CREATE SCHEMA IF NOT EXISTS \"drizzle\";
            CREATE TABLE IF NOT EXISTS \"drizzle\".\"__drizzle_migrations\" (
              id SERIAL PRIMARY KEY,
              hash text NOT NULL,
              created_at bigint
            );
          "

          SCHEMA_EXISTS=$(docker compose -f compose.yaml exec -T db psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" -t -c \
            "SELECT EXISTS(SELECT 1 FROM pg_type WHERE typname = 'question_type');" | tr -d ' \r\n')

          MIGRATION_COUNT=$(docker compose -f compose.yaml exec -T db psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" -t -c \
            "SELECT COUNT(*) FROM \"drizzle\".\"__drizzle_migrations\";" | tr -d ' \r\n')

          if [ "$SCHEMA_EXISTS" = "f" ] && [ "$MIGRATION_COUNT" != "0" ]; then
            echo "Database is empty but has stale migration tracking — clearing..."
            docker compose -f compose.yaml exec -T db psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c \
              "DELETE FROM \"drizzle\".\"__drizzle_migrations\";"
            MIGRATION_COUNT="0"
          fi

          if [ "$MIGRATION_COUNT" = "0" ] && [ "$SCHEMA_EXISTS" = "t" ]; then
            echo "First migrate run — marking existing migrations (0000-0005) as applied..."
            HASH_0005=$(docker compose -f compose.yaml run -T --rm migrate sh -c \
              "sha256sum drizzle/0005_melted_proemial_gods.sql | cut -d' ' -f1")
            HASH_0005=$(echo "$HASH_0005" | tr -d ' \r\n')
            docker compose -f compose.yaml exec -T db psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c \
              "INSERT INTO \"drizzle\".\"__drizzle_migrations\" (hash, created_at) VALUES ('$HASH_0005', 1766791441364);"
            echo "Done — migrations 0000-0005 marked as applied"
          elif [ "$MIGRATION_COUNT" = "0" ] && [ "$SCHEMA_EXISTS" = "f" ]; then
            echo "Fresh database — all migrations will run from scratch"
          else
            echo "Migration tracking initialized ($MIGRATION_COUNT entries)"
          fi

      - name: Run database migrations
        run: docker compose -f compose.yaml run -T --rm migrate npx drizzle-kit migrate

      - name: Check if seeding is needed
        id: check-seed
        run: |
          FORCE_SEED="${{ github.event.inputs.force_seed }}"

          if [ "$FORCE_SEED" = "true" ]; then
            echo "⚠️  FORCE SEED ENABLED - Will wipe and re-seed database!"
            echo "needs_seed=true" >> $GITHUB_OUTPUT
            echo "force_mode=true" >> $GITHUB_OUTPUT
          else
            LEVEL_COUNT=$(docker compose -f compose.yaml exec -T db psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" -t -c "SELECT COUNT(*) FROM levels;" 2>/dev/null | tr -d ' ' || echo "0")
            echo "Level count: $LEVEL_COUNT"
            if [ "$LEVEL_COUNT" = "0" ] || [ -z "$LEVEL_COUNT" ]; then
              echo "needs_seed=true" >> $GITHUB_OUTPUT
              echo "force_mode=false" >> $GITHUB_OUTPUT
              echo "Database needs seeding (empty)"
            else
              echo "needs_seed=false" >> $GITHUB_OUTPUT
              echo "force_mode=false" >> $GITHUB_OUTPUT
              echo "Database already seeded ($LEVEL_COUNT levels) - skipping seed"
            fi
          fi

      - name: ⚠️ Warning - Force seed will delete all data
        if: steps.check-seed.outputs.force_mode == 'true'
        run: |
          echo "════════════════════════════════════════════════"
          echo "⚠️  FORCE SEED MODE ACTIVE"
          echo "════════════════════════════════════════════════"
          echo ""
          echo "This will DELETE ALL DATA including:"
          echo "  • User accounts and profiles"
          echo "  • User progress and stats"
          echo "  • Lesson completions"
          echo "  • Achievements earned"
          echo "  • Chat sessions"
          echo "  • All user data"
          echo ""
          echo "════════════════════════════════════════════════"
          sleep 3

      - name: Seed database
        if: steps.check-seed.outputs.needs_seed == 'true'
        run: docker compose -f compose.yaml run --rm migrate npm run db:seed

      - name: Seed learning content (skill tree)
        run: docker compose -f compose.yaml run --rm migrate npm run db:seed:learning

      - name: Seed shop items
        run: docker compose -f compose.yaml run --rm -e DATABASE_URL=postgres://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@db:5432/${{ secrets.POSTGRES_DB }} migrate npx tsx scripts/seed-shop.ts

      - name: Build and start app
        run: docker compose -f compose.yaml up -d --build app

      - name: Wait for app to be ready
        run: |
          echo "Waiting for app to start..."
          sleep 5
          timeout 30 bash -c 'until curl -sf http://localhost:2004/ > /dev/null; do sleep 2; done'
          echo "App is ready"

      - name: Verify deployment
        run: |
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:2004/)
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Deployment successful - HTTP $HTTP_STATUS"
          else
            echo "Deployment verification failed - HTTP $HTTP_STATUS"
            docker compose -f compose.yaml logs app --tail=50
            exit 1
          fi

      - name: Clean up old Docker images
        run: docker image prune -f || true
